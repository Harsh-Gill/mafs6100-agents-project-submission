<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgenticTraders Research Lab üß™üìä</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
        }
        
        .nav-tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .nav-tab:hover {
            border-color: #00d4ff;
            color: #00d4ff;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-color: #00d4ff;
            color: white;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
        }
        
        header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #00d4ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        header p {
            color: rgba(255,255,255,0.7);
            font-size: 1.1em;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .experiment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .experiment-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .experiment-card:hover {
            border-color: #00d4ff;
            transform: translateY(-5px);
        }
        
        .experiment-card.selected {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }
        
        .experiment-card h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
        }
        
        .experiment-card .config-badges {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge.on {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .badge.off {
            background: rgba(255,77,77,0.2);
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,212,255,0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn-run {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #1a1a2e;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            color: #00d4ff;
        }
        
        .stat-box .label {
            font-size: 0.85em;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th, .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .comparison-table th {
            color: #00d4ff;
            font-weight: 600;
        }
        
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4d4d; }
        
        .memory-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 4px solid #764ba2;
        }
        
        .memory-item .meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85em;
            color: rgba(255,255,255,0.6);
        }
        
        .psychology-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .agent-psych-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
        }
        
        .agent-psych-card .name {
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 8px;
        }
        
        .desperation-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .desperation-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .run-launcher {
            background: rgba(0,212,255,0.1);
            border: 2px dashed #00d4ff;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .run-launcher h3 {
            margin-bottom: 20px;
            color: #00d4ff;
        }
        
        .run-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group label {
            color: rgba(255,255,255,0.7);
        }
        
        .input-group input, .input-group select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }
        
        .toggle-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: rgba(255,255,255,0.5);
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <nav class="nav-tabs">
        <button class="nav-tab active" onclick="showView('arena')">üèüÔ∏è Arena</button>
        <button class="nav-tab" onclick="showView('ablation')">üß™ Ablation Study</button>
        <button class="nav-tab" onclick="showView('analysis')">üß† Behavioral & Manager Analysis</button>
        <button class="nav-tab" onclick="window.open('/dashboard', '_blank')">üìä Classic Dashboard</button>
    </nav>
    
    <div class="container">
        <!-- ARENA VIEW -->
        <div id="arena-view" class="view active">
            <header>
                <h1>üèüÔ∏è Experiment Arena</h1>
                <p>Launch and monitor ablation study experiments</p>
            </header>
            
            <div class="card">
                <h2>üìã Experiment History</h2>
                <div id="experiment-history">
                    <div class="loading">Loading experiments</div>
                </div>
            </div>
        </div>
        
        <!-- ABLATION STUDY VIEW -->
        <div id="ablation-view" class="view">
            <header>
                <h1>üß™ Ablation Study</h1>
                <p>Compare the value added by each AI component</p>
            </header>
            
            <div class="card">
                <h2>Select Runs to Compare</h2>
                <div id="run-selector" class="experiment-grid">
                    <div class="loading">Loading runs</div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="runComparison()">üìä Run Comparison</button>
                </div>
            </div>
            
            <div id="comparison-results" style="display: none;">
                <div class="stats-grid" id="comparison-stats"></div>
                
                <div class="card">
                    <h2>üìà Value Added by Components</h2>
                    <div class="chart-container">
                        <canvas id="ablationChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìä Return Distribution</h2>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìã Detailed Comparison</h2>
                    <table class="comparison-table" id="comparison-table">
                        <thead>
                            <tr>
                                <th>Run</th>
                                <th>Config</th>
                                <th>Avg Return</th>
                                <th>Std Dev</th>
                                <th>Sharpe</th>
                                <th>Win Rate</th>
                                <th>Œî vs Baseline</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- COMBINED BEHAVIORAL & MANAGER ANALYSIS VIEW -->
        <div id="analysis-view" class="view">
            <header>
                <h1>üß† Behavioral & Manager Analysis</h1>
                <p>Comparing agent psychology and manager impact across all experiment runs</p>
            </header>
            
            <div id="analysis-loading" class="loading">Loading analysis data for all runs...</div>
            
            <div id="analysis-content" style="display: none;">
                <!-- Run Summary Cards -->
                <div class="card">
                    <h2>üìä All Experiment Runs Overview</h2>
                    <div id="runs-overview" class="experiment-grid"></div>
                </div>
                
                <!-- Manager Feedback Summary -->
                <div class="card">
                    <h2>üë®‚Äçüíº Manager Feedback Summary</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        Total feedback given to agents across all runs with Manager enabled
                    </p>
                    <div id="feedback-summary"></div>
                </div>
                
                <!-- Desperation Comparison Across Runs -->
                <div class="card">
                    <h2>üé∞ Desperation Index Comparison</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        Positive = Agent takes MORE risk when losing (gambling for resurrection)<br>
                        Negative = Agent takes LESS risk when losing (playing it safe)
                    </p>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="desperationComparisonChart"></canvas>
                    </div>
                </div>
                
                <!-- Rescue Effect Comparison -->
                <div class="card">
                    <h2>üöë The Rescue Effect</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        How the <strong>Bottom 3 Agents</strong> perform with vs without Manager oversight
                    </p>
                    <div id="rescue-comparison"></div>
                </div>
                
                <!-- Agent Performance Table -->
                <div class="card">
                    <h2>üìã Agent Performance by Run</h2>
                    <div style="overflow-x: auto;">
                        <table class="comparison-table" id="agent-performance-table">
                            <thead>
                                <tr>
                                    <th>Agent</th>
                                    <th>Personality</th>
                                    <th id="run-headers"></th>
                                </tr>
                            </thead>
                            <tbody id="agent-performance-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Compliance Stats -->
                <div class="card">
                    <h2>üó£Ô∏è Coachability: Do Agents Listen?</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        How often agents reduced risk after receiving "High Risk" feedback from the Manager
                    </p>
                    <div id="compliance-summary" class="stats-grid"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://mafs6100-agents-project-submission.fly.dev';
        let selectedRuns = new Set();
        let ablationChart = null;
        let distributionChart = null;
        let desperationComparisonChart = null;
        
        // View switching
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');
            event.target.classList.add('active');
            
            if (view === 'ablation') loadRunSelector();
            if (view === 'analysis') loadCombinedAnalysis();
            if (view === 'arena') loadExperimentHistory();
        }
        
        // ARENA: Launch experiment
        async function launchExperiment() {
            const config = {
                start_year: parseInt(document.getElementById('startYear').value),
                end_year: parseInt(document.getElementById('endYear').value),
                learning_years: parseInt(document.getElementById('learningYears').value),
                enable_memory: document.getElementById('enableMemory').checked,
                enable_reflection: document.getElementById('enableReflection').checked,
                enable_manager: document.getElementById('enableManager').checked,
                description: document.getElementById('experimentName').value || 'Unnamed Experiment'
            };
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Running...';
            
            try {
                const response = await fetch(`${API_BASE}/backtest/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                alert(`‚úÖ Experiment complete! Run ID: ${result.run_id}`);
                loadExperimentHistory();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Launch Experiment';
            }
        }
        
        // ARENA: Load experiment history
        async function loadExperimentHistory() {
            try {
                const response = await fetch(`${API_BASE}/runs`);
                const runs = await response.json();
                
                const container = document.getElementById('experiment-history');
                
                if (runs.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">No experiments yet. Launch one above!</p>';
                    return;
                }
                
                let html = '<table class="comparison-table"><thead><tr><th>Run ID</th><th>Period</th><th>Config</th><th>Trades</th></tr></thead><tbody>';
                
                for (const run of runs) {
                    const config = run.config || {};
                    const configBadges = `
                        <span class="badge ${config.enable_memory ? 'on' : 'off'}">üß† Memory</span>
                        <span class="badge ${config.enable_reflection ? 'on' : 'off'}">üìù Reflect</span>
                        <span class="badge ${config.enable_manager ? 'on' : 'off'}">üë®‚Äçüíº Manager</span>
                    `;
                    
                    html += `<tr>
                        <td><strong>#${run.run_id}</strong> ${config.description || ''}</td>
                        <td>${run.start_month} ‚Üí ${run.end_month}</td>
                        <td>${configBadges}</td>
                        <td>${run.total_trades}</td>
                    </tr>`;
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('experiment-history').innerHTML = `<p style="color: #ff4d4d;">Error loading: ${error.message}</p>`;
            }
        }
        
        // ABLATION: Load run selector
        async function loadRunSelector() {
            try {
                const response = await fetch(`${API_BASE}/runs`);
                const runs = await response.json();
                
                const container = document.getElementById('run-selector');
                
                if (runs.length === 0) {
                    container.innerHTML = '<p>No runs available. Launch experiments in the Arena first.</p>';
                    return;
                }
                
                let html = '';
                for (const run of runs) {
                    const config = run.config || {};
                    const isSelected = selectedRuns.has(run.run_id);
                    
                    html += `
                        <div class="experiment-card ${isSelected ? 'selected' : ''}" onclick="toggleRunSelection(${run.run_id}, this)">
                            <h3>Run #${run.run_id}</h3>
                            <p style="color: rgba(255,255,255,0.6); font-size: 0.9em;">${config.description || 'No description'}</p>
                            <div class="config-badges">
                                <span class="badge ${config.enable_memory ? 'on' : 'off'}">üß† Memory</span>
                                <span class="badge ${config.enable_reflection ? 'on' : 'off'}">üìù Reflect</span>
                                <span class="badge ${config.enable_manager ? 'on' : 'off'}">üë®‚Äçüíº Manager</span>
                            </div>
                            <p style="font-size: 0.85em; color: rgba(255,255,255,0.5);">${run.start_month} ‚Üí ${run.end_month}</p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('run-selector').innerHTML = `<p style="color: #ff4d4d;">Error: ${error.message}</p>`;
            }
        }
        
        function toggleRunSelection(runId, element) {
            if (selectedRuns.has(runId)) {
                selectedRuns.delete(runId);
                element.classList.remove('selected');
            } else {
                selectedRuns.add(runId);
                element.classList.add('selected');
            }
        }
        
        // ABLATION: Run comparison
        async function runComparison() {
            if (selectedRuns.size < 2) {
                alert('Please select at least 2 runs to compare');
                return;
            }
            
            const runIds = Array.from(selectedRuns).join(',');
            
            try {
                const response = await fetch(`${API_BASE}/research/compare?run_ids=${runIds}`);
                const data = await response.json();
                
                document.getElementById('comparison-results').style.display = 'block';
                renderComparisonResults(data);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function renderComparisonResults(data) {
            // Summary stats
            const statsHtml = data.map(run => `
                <div class="stat-box">
                    <div class="value">${run.metrics.avg_return.toFixed(1)}%</div>
                    <div class="label">Run #${run.run_id} Avg Return</div>
                </div>
            `).join('');
            document.getElementById('comparison-stats').innerHTML = statsHtml;
            
            // Ablation bar chart
            if (ablationChart) ablationChart.destroy();
            const ctx1 = document.getElementById('ablationChart').getContext('2d');
            ablationChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: data.map(r => `Run #${r.run_id}`),
                    datasets: [{
                        label: 'Average Return (%)',
                        data: data.map(r => r.metrics.avg_return),
                        backgroundColor: data.map((_, i) => 
                            `hsla(${180 + i * 30}, 80%, 50%, 0.7)`
                        ),
                        borderColor: data.map((_, i) => 
                            `hsla(${180 + i * 30}, 80%, 50%, 1)`
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // Distribution chart (box plot approximation using bar + error)
            if (distributionChart) distributionChart.destroy();
            const ctx2 = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.map(r => `Run #${r.run_id}`),
                    datasets: [
                        {
                            label: 'Worst',
                            data: data.map(r => r.metrics.worst_return),
                            backgroundColor: 'rgba(255,77,77,0.7)'
                        },
                        {
                            label: 'Average',
                            data: data.map(r => r.metrics.avg_return),
                            backgroundColor: 'rgba(0,212,255,0.7)'
                        },
                        {
                            label: 'Best',
                            data: data.map(r => r.metrics.best_return),
                            backgroundColor: 'rgba(0,255,136,0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // Comparison table
            const baseline = data[0].metrics.avg_return;
            const tableBody = document.querySelector('#comparison-table tbody');
            tableBody.innerHTML = data.map(run => {
                const config = run.config || {};
                const delta = run.metrics.avg_return - baseline;
                const deltaClass = delta > 0 ? 'positive' : (delta < 0 ? 'negative' : '');
                
                const configStr = [
                    config.enable_memory ? 'üß†' : '',
                    config.enable_reflection ? 'üìù' : '',
                    config.enable_manager ? 'üë®‚Äçüíº' : ''
                ].filter(Boolean).join(' ') || 'Baseline';
                
                return `<tr>
                    <td><strong>#${run.run_id}</strong></td>
                    <td>${configStr}</td>
                    <td>${run.metrics.avg_return.toFixed(2)}%</td>
                    <td>${run.metrics.std_return.toFixed(2)}%</td>
                    <td>${run.metrics.avg_sharpe.toFixed(2)}</td>
                    <td>${run.metrics.avg_win_rate.toFixed(1)}%</td>
                    <td class="${deltaClass}">${delta > 0 ? '+' : ''}${delta.toFixed(2)}%</td>
                </tr>`;
            }).join('');
        }
        
        // COMBINED ANALYSIS: Load all data at once
        async function loadCombinedAnalysis() {
            const loadingEl = document.getElementById('analysis-loading');
            const contentEl = document.getElementById('analysis-content');
            
            loadingEl.style.display = 'block';
            loadingEl.innerHTML = 'Loading analysis data for all runs...';
            contentEl.style.display = 'none';
            
            try {
                // 1. Get all runs and agents in parallel
                const [runsResponse, agentsResponse] = await Promise.all([
                    fetch(`${API_BASE}/runs`),
                    fetch(`${API_BASE}/agents`)
                ]);
                
                const runs = await runsResponse.json();
                const agents = await agentsResponse.json();
                
                if (runs.length === 0) {
                    loadingEl.innerHTML = '<p>No experiment runs available. Launch experiments in the Arena first!</p>';
                    return;
                }
                
                loadingEl.innerHTML = `Loading data for ${runs.length} runs...`;
                
                // 2. Get leaderboards for all runs in parallel
                const leaderboardPromises = runs.map(run => 
                    fetch(`${API_BASE}/leaderboard?run_id=${run.run_id}`)
                        .then(r => r.json())
                        .catch(() => [])
                );
                const leaderboardResults = await Promise.all(leaderboardPromises);
                
                const leaderboards = {};
                runs.forEach((run, i) => {
                    leaderboards[run.run_id] = leaderboardResults[i];
                });
                
                // 3. Get feedback for manager-enabled runs (simplified - just count)
                const feedbackByRun = {};
                const managerRuns = runs.filter(r => r.config?.enable_manager);
                
                for (const run of managerRuns) {
                    try {
                        // Just get feedback for first agent to check if API works
                        const fbResponse = await fetch(`${API_BASE}/agents/1/feedback?run_id=${run.run_id}`);
                        const fb = await fbResponse.json();
                        feedbackByRun[run.run_id] = fb;
                    } catch (e) {
                        feedbackByRun[run.run_id] = [];
                    }
                }
                
                // 4. Try to get impact analysis if we have baseline and manager runs
                const baselineRun = runs.find(r => !r.config?.enable_manager);
                const managerRun = runs.find(r => r.config?.enable_manager);
                let impactData = null;
                
                if (baselineRun && managerRun) {
                    try {
                        const impactResponse = await fetch(`${API_BASE}/research/impact?baseline_run_id=${baselineRun.run_id}&manager_run_id=${managerRun.run_id}`);
                        impactData = await impactResponse.json();
                        if (impactData.error) impactData = null;
                    } catch (e) {
                        console.error('Failed to load impact data:', e);
                    }
                }
                
                // Render with available data
                renderCombinedAnalysis(runs, agents, leaderboards, feedbackByRun, impactData);
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                
            } catch (error) {
                console.error('Analysis error:', error);
                loadingEl.innerHTML = `<p style="color: #ff4d4d;">Error loading analysis: ${error.message}</p>`;
            }
        }
        
        function renderCombinedAnalysis(runs, agents, leaderboards, feedbackByRun, impactData) {
            // 1. Runs Overview
            const runsOverview = document.getElementById('runs-overview');
            runsOverview.innerHTML = runs.map(run => {
                const config = run.config || {};
                const lb = leaderboards[run.run_id] || [];
                const avgReturn = lb.length > 0 ? (lb.reduce((s, a) => s + a.total_return, 0) / lb.length).toFixed(1) : 'N/A';
                
                return `
                    <div class="experiment-card">
                        <h3>Run #${run.run_id}</h3>
                        <p style="color: rgba(255,255,255,0.6); font-size: 0.9em;">${config.description || 'No description'}</p>
                        <div class="config-badges">
                            <span class="badge ${config.enable_memory ? 'on' : 'off'}">üß† Memory</span>
                            <span class="badge ${config.enable_reflection ? 'on' : 'off'}">üìù Reflect</span>
                            <span class="badge ${config.enable_manager ? 'on' : 'off'}">üë®‚Äçüíº Manager</span>
                        </div>
                        <p style="font-size: 0.85em; color: rgba(255,255,255,0.5);">${run.start_month || 'N/A'} ‚Üí ${run.end_month || 'N/A'}</p>
                        <p style="margin-top: 10px; font-size: 1.2em; color: #00d4ff;">Avg Return: ${avgReturn}%</p>
                    </div>
                `;
            }).join('');
            
            // 2. Manager Feedback Summary
            const feedbackSummary = document.getElementById('feedback-summary');
            const feedbackRuns = Object.entries(feedbackByRun);
            
            if (feedbackRuns.length === 0) {
                feedbackSummary.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center;">No runs with Manager enabled found.</p>';
            } else {
                let fbHtml = '<div class="stats-grid">';
                for (const [runId, feedbacks] of feedbackRuns) {
                    const run = runs.find(r => r.run_id == runId);
                    fbHtml += `
                        <div class="stat-box">
                            <div class="value">${Array.isArray(feedbacks) ? feedbacks.length : 0}</div>
                            <div class="label">Run #${runId} Feedback Count</div>
                        </div>
                    `;
                }
                fbHtml += '</div>';
                feedbackSummary.innerHTML = fbHtml;
            }
            
            // 3. Agent Performance Comparison Chart
            if (desperationComparisonChart) desperationComparisonChart.destroy();
            
            const ctx = document.getElementById('desperationComparisonChart').getContext('2d');
            const datasets = [];
            const colors = ['#00d4ff', '#ff00ff', '#00ff88', '#ffaa00', '#ff4d4d'];
            
            runs.forEach((run, i) => {
                const lb = leaderboards[run.run_id] || [];
                if (lb.length === 0) return;
                
                datasets.push({
                    label: `Run #${run.run_id} (${run.config?.description || 'No desc'})`,
                    data: lb.map(a => a.total_return),
                    backgroundColor: colors[i % colors.length] + '99',
                    borderColor: colors[i % colors.length],
                    borderWidth: 2
                });
            });
            
            const firstLb = Object.values(leaderboards).find(lb => lb?.length > 0) || [];
            const agentNames = firstLb.map(a => a.name);
            
            desperationComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: agentNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        title: { display: true, text: 'Total Return by Agent Across Runs', color: 'white' }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: { display: true, text: 'Total Return (%)', color: 'white' }
                        },
                        x: {
                            ticks: { color: 'white', maxRotation: 45 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // 4. Rescue Effect Comparison
            const rescueContainer = document.getElementById('rescue-comparison');
            
            if (impactData && impactData.rescue_analysis && impactData.rescue_analysis.length > 0) {
                let rescueHtml = `
                    <div class="stats-grid">
                        ${impactData.rescue_analysis.map(agent => {
                            const improvement = ((agent.manager_final - agent.baseline_final) / agent.baseline_final * 100);
                            const impClass = improvement > 0 ? 'positive' : 'negative';
                            return `
                            <div class="stat-box">
                                <div class="value" style="font-size: 1.2em;">${agent.name}</div>
                                <div style="margin-top: 10px;">
                                    <span style="color: #ff4d4d;">Baseline: $${agent.baseline_final.toFixed(0)}</span>
                                    <span style="margin: 0 10px;">‚Üí</span>
                                    <span style="color: #00ff88;">Manager: $${agent.manager_final.toFixed(0)}</span>
                                </div>
                                <div class="label ${impClass}" style="margin-top: 5px; font-size: 1.1em;">
                                    ${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}%
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    <p style="color: rgba(255,255,255,0.6); margin-top: 15px; text-align: center;">
                        The bottom 3 agents from the baseline run showing their performance with Manager oversight
                    </p>
                `;
                rescueContainer.innerHTML = rescueHtml;
            } else {
                rescueContainer.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center;">Need both a Baseline (no manager) and Manager run to compare the rescue effect.</p>';
            }
            
            // 5. Agent Performance Table
            const tableHeader = document.getElementById('run-headers');
            const tableBody = document.getElementById('agent-performance-body');
            
            tableHeader.outerHTML = runs.map(r => `<th>Run #${r.run_id}</th>`).join('');
            
            tableBody.innerHTML = agents.map(agent => {
                const cells = runs.map(run => {
                    const lb = leaderboards[run.run_id] || [];
                    const agentData = lb.find(a => a.agent_id === agent.id);
                    if (!agentData) return '<td>-</td>';
                    
                    const retClass = agentData.total_return > 0 ? 'positive' : 'negative';
                    return `<td class="${retClass}">${agentData.total_return.toFixed(1)}%</td>`;
                }).join('');
                
                return `
                    <tr>
                        <td><strong>${agent.name}</strong></td>
                        <td style="color: rgba(255,255,255,0.6);">${agent.personality}</td>
                        ${cells}
                    </tr>
                `;
            }).join('');
            
            // 6. Compliance Stats
            const complianceSummary = document.getElementById('compliance-summary');
            
            if (impactData && impactData.compliance_stats) {
                const comp = impactData.compliance_stats;
                const complianceRate = comp.total_risk_feedback > 0 ? (comp.compliant / comp.total_risk_feedback * 100) : 0;
                
                complianceSummary.innerHTML = `
                    <div class="stat-box">
                        <div class="value">${complianceRate.toFixed(1)}%</div>
                        <div class="label">Compliance Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" style="color: #00ff88;">${comp.compliant}</div>
                        <div class="label">Listened (Reduced Risk)</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" style="color: #ff4d4d;">${comp.non_compliant}</div>
                        <div class="label">Ignored Feedback</div>
                    </div>
                    <div class="stat-box">
                        <div class="value">${comp.total_risk_feedback}</div>
                        <div class="label">Total Risk Warnings</div>
                    </div>
                `;
            } else {
                complianceSummary.innerHTML = '<div class="stat-box" style="grid-column: span 4;"><p style="color: rgba(255,255,255,0.5); text-align: center;">Need Manager-enabled runs to analyze compliance.</p></div>';
            }
        }
        
        // Initialize
        loadExperimentHistory();
    </script>
</body>
</html>