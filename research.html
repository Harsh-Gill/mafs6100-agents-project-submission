<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgenticTraders Research Lab üß™üìä</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
        }
        
        .nav-tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .nav-tab:hover {
            border-color: #00d4ff;
            color: #00d4ff;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border-color: #00d4ff;
            color: white;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
        }
        
        header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #00d4ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        header p {
            color: rgba(255,255,255,0.7);
            font-size: 1.1em;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .experiment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .experiment-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .experiment-card:hover {
            border-color: #00d4ff;
            transform: translateY(-5px);
        }
        
        .experiment-card.selected {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }
        
        .experiment-card h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
        }
        
        .experiment-card .config-badges {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge.on {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .badge.off {
            background: rgba(255,77,77,0.2);
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,212,255,0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn-run {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #1a1a2e;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 2em;
            font-weight: 700;
            color: #00d4ff;
        }
        
        .stat-box .label {
            font-size: 0.85em;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin: 20px 0;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th, .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .comparison-table th {
            color: #00d4ff;
            font-weight: 600;
        }
        
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4d4d; }
        
        .psychology-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .agent-psych-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
        }
        
        .agent-psych-card .name {
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 8px;
        }
        
        .desperation-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .desperation-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .run-launcher {
            background: rgba(0,212,255,0.1);
            border: 2px dashed #00d4ff;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .run-launcher h3 {
            margin-bottom: 20px;
            color: #00d4ff;
        }
        
        .run-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group label {
            color: rgba(255,255,255,0.7);
        }
        
        .input-group input, .input-group select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }
        
        .toggle-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: rgba(255,255,255,0.5);
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <nav class="nav-tabs">
        <button class="nav-tab active" onclick="showView('arena')">üèüÔ∏è Arena</button>
        <button class="nav-tab" onclick="showView('ablation')">üß™ Ablation Study</button>
        <button class="nav-tab" onclick="showView('psychology')">üß† Behavioral Lab</button>
        <button class="nav-tab" onclick="showView('impact')">üë®‚Äçüíº Manager Impact</button>
        <button class="nav-tab" onclick="window.open('dashboard.html', '_blank')">üìä Classic Dashboard</button>
    </nav>
    
    <div class="container">
        <!-- ARENA VIEW -->
        <div id="arena-view" class="view active">
            <header>
                <h1>üèüÔ∏è Experiment Arena</h1>
                <p>Launch and monitor ablation study experiments</p>
            </header>
            
            <div class="run-launcher">
                <h3>üöÄ Launch New Experiment</h3>
                <div class="input-group" style="justify-content: center; margin-bottom: 15px;">
                    <label>Period:</label>
                    <input type="number" id="startYear" value="2018" min="2010" max="2024" style="width: 80px;">
                    <span>to</span>
                    <input type="number" id="endYear" value="2023" min="2011" max="2025" style="width: 80px;">
                    <label style="margin-left: 20px;">Learning Years:</label>
                    <input type="number" id="learningYears" value="0" min="0" max="5" style="width: 60px;">
                </div>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <input type="checkbox" id="enableMemory">
                        <label for="enableMemory">üß† Memory (RAG)</label>
                    </div>
                    <div class="toggle-item">
                        <input type="checkbox" id="enableReflection">
                        <label for="enableReflection">üìù Reflection (Notes)</label>
                    </div>
                    <div class="toggle-item">
                        <input type="checkbox" id="enableManager">
                        <label for="enableManager">üë®‚Äçüíº Manager Feedback</label>
                    </div>
                </div>
                <div class="input-group" style="justify-content: center; margin: 15px 0;">
                    <label>Experiment Name:</label>
                    <input type="text" id="experimentName" placeholder="e.g., Baseline Run" style="width: 300px;">
                </div>
                <button class="btn btn-run" onclick="launchExperiment()">üöÄ Launch Experiment</button>
            </div>
            
            <div class="card">
                <h2>üìã Experiment History</h2>
                <div id="experiment-history">
                    <div class="loading">Loading experiments</div>
                </div>
            </div>
        </div>
        
        <!-- ABLATION STUDY VIEW -->
        <div id="ablation-view" class="view">
            <header>
                <h1>üß™ Ablation Study</h1>
                <p>Compare the value added by each AI component</p>
            </header>
            
            <div class="card">
                <h2>Select Runs to Compare</h2>
                <div id="run-selector" class="experiment-grid">
                    <div class="loading">Loading runs</div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="runComparison()">üìä Run Comparison</button>
                </div>
            </div>
            
            <div id="comparison-results" style="display: none;">
                <div class="stats-grid" id="comparison-stats"></div>
                
                <div class="card">
                    <h2>üìà Value Added by Components</h2>
                    <div class="chart-container">
                        <canvas id="ablationChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìä Return Distribution</h2>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìã Detailed Comparison</h2>
                    <table class="comparison-table" id="comparison-table">
                        <thead>
                            <tr>
                                <th>Run</th>
                                <th>Config</th>
                                <th>Avg Return</th>
                                <th>Std Dev</th>
                                <th>Sharpe</th>
                                <th>Win Rate</th>
                                <th>Œî vs Baseline</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- BEHAVIORAL LAB VIEW -->
        <div id="psychology-view" class="view">
            <header>
                <h1>üß† Behavioral Lab</h1>
                <p>Analyze AI psychology: Do rankings affect risk-taking?</p>
            </header>
            
            <div class="card">
                <h2>Select Run to Analyze</h2>
                <div class="input-group" style="justify-content: center;">
                    <label>Run ID:</label>
                    <select id="psychRunSelect" onchange="loadPsychologyData()">
                        <option value="">Select a run...</option>
                    </select>
                </div>
            </div>
            
            <div id="psychology-results" style="display: none;">
                <div class="stats-grid" id="psych-summary-stats"></div>
                
                <div class="card">
                    <h2>üé∞ Desperation Index</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        Positive = Agent takes MORE risk when losing (gambling for resurrection)<br>
                        Negative = Agent takes LESS risk when losing (playing it safe)
                    </p>
                    <div class="chart-container">
                        <canvas id="desperationChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üìä Risk by Ranking Position</h2>
                    <div class="chart-container">
                        <canvas id="riskByRankChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>ü§ñ Agent Psychology Profiles</h2>
                    <div class="psychology-grid" id="agent-profiles"></div>
                </div>
            </div>
        </div>

        <!-- MANAGER IMPACT VIEW -->
        <div id="impact-view" class="view">
            <header>
                <h1>üë®‚Äçüíº Manager Impact Analysis</h1>
                <p>Quantifying the value of oversight: Do agents listen? Do losers recover?</p>
            </header>
            
            <div class="card">
                <h2>Select Runs to Compare</h2>
                <div class="run-options">
                    <div class="input-group">
                        <label>Baseline Run (No Manager):</label>
                        <select id="impactBaselineSelect"></select>
                    </div>
                    <div class="input-group">
                        <label>Manager Run (Full System):</label>
                        <select id="impactManagerSelect"></select>
                    </div>
                    <button class="btn btn-primary" onclick="runImpactAnalysis()">Analyze Impact</button>
                </div>
            </div>
            
            <div id="impact-results" style="display: none;">
                <div class="stats-grid" id="impact-stats"></div>
                
                <div class="card">
                    <h2>üöë The Rescue Effect</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        Performance of the <strong>Bottom 3 Agents</strong> (from Baseline) when supervised by a Manager.
                    </p>
                    <div class="chart-container">
                        <canvas id="rescueChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üó£Ô∏è Coachability: Feedback Compliance</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                        How often agents reduced risk immediately after receiving "High Risk" feedback.
                    </p>
                    <div class="chart-container" style="height: 300px; width: 500px; margin: 0 auto;">
                        <canvas id="complianceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://mafs6100-agents-project-submission.fly.dev';
        let selectedRuns = new Set();
        let ablationChart = null;
        let distributionChart = null;
        let desperationChart = null;
        let riskByRankChart = null;
        let rescueChart = null;
        let complianceChart = null;
        
        // View switching
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');
            event.target.classList.add('active');
            
            if (view === 'ablation') loadRunSelector();
            if (view === 'psychology') loadPsychRuns();
            if (view === 'impact') loadImpactRuns();
            if (view === 'arena') loadExperimentHistory();
        }
        
        // ARENA: Launch experiment
        async function launchExperiment() {
            const config = {
                start_year: parseInt(document.getElementById('startYear').value),
                end_year: parseInt(document.getElementById('endYear').value),
                learning_years: parseInt(document.getElementById('learningYears').value),
                enable_memory: document.getElementById('enableMemory').checked,
                enable_reflection: document.getElementById('enableReflection').checked,
                enable_manager: document.getElementById('enableManager').checked,
                description: document.getElementById('experimentName').value || 'Unnamed Experiment'
            };
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Running...';
            
            try {
                const response = await fetch(`${API_BASE}/backtest/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                alert(`‚úÖ Experiment complete! Run ID: ${result.run_id}`);
                loadExperimentHistory();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Launch Experiment';
            }
        }
        
        // ARENA: Load experiment history
        async function loadExperimentHistory() {
            try {
                const response = await fetch(`${API_BASE}/runs`);
                const runs = await response.json();
                
                const container = document.getElementById('experiment-history');
                
                if (runs.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">No experiments yet. Launch one above!</p>';
                    return;
                }
                
                let html = '<table class="comparison-table"><thead><tr><th>Run ID</th><th>Period</th><th>Config</th><th>Trades</th></tr></thead><tbody>';
                
                for (const run of runs) {
                    const config = run.config || {};
                    const configBadges = `
                        <span class="badge ${config.enable_memory ? 'on' : 'off'}">üß† Memory</span>
                        <span class="badge ${config.enable_reflection ? 'on' : 'off'}">üìù Reflect</span>
                        <span class="badge ${config.enable_manager ? 'on' : 'off'}">üë®‚Äçüíº Manager</span>
                    `;
                    
                    html += `<tr>
                        <td><strong>#${run.run_id}</strong> ${config.description || ''}</td>
                        <td>${run.start_month} ‚Üí ${run.end_month}</td>
                        <td>${configBadges}</td>
                        <td>${run.total_trades}</td>
                    </tr>`;
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('experiment-history').innerHTML = `<p style="color: #ff4d4d;">Error loading: ${error.message}</p>`;
            }
        }
        
        // ABLATION: Load run selector
        async function loadRunSelector() {
            try {
                const response = await fetch(`${API_BASE}/runs`);
                const runs = await response.json();
                
                const container = document.getElementById('run-selector');
                
                if (runs.length === 0) {
                    container.innerHTML = '<p>No runs available. Launch experiments in the Arena first.</p>';
                    return;
                }
                
                let html = '';
                for (const run of runs) {
                    const config = run.config || {};
                    const isSelected = selectedRuns.has(run.run_id);
                    
                    html += `
                        <div class="experiment-card ${isSelected ? 'selected' : ''}" onclick="toggleRunSelection(${run.run_id}, this)">
                            <h3>Run #${run.run_id}</h3>
                            <p style="color: rgba(255,255,255,0.6); font-size: 0.9em;">${config.description || 'No description'}</p>
                            <div class="config-badges">
                                <span class="badge ${config.enable_memory ? 'on' : 'off'}">üß† Memory</span>
                                <span class="badge ${config.enable_reflection ? 'on' : 'off'}">üìù Reflect</span>
                                <span class="badge ${config.enable_manager ? 'on' : 'off'}">üë®‚Äçüíº Manager</span>
                            </div>
                            <p style="font-size: 0.85em; color: rgba(255,255,255,0.5);">${run.start_month} ‚Üí ${run.end_month}</p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('run-selector').innerHTML = `<p style="color: #ff4d4d;">Error: ${error.message}</p>`;
            }
        }
        
        function toggleRunSelection(runId, element) {
            if (selectedRuns.has(runId)) {
                selectedRuns.delete(runId);
                element.classList.remove('selected');
            } else {
                selectedRuns.add(runId);
                element.classList.add('selected');
            }
        }
        
        // ABLATION: Run comparison
        async function runComparison() {
            if (selectedRuns.size < 2) {
                alert('Please select at least 2 runs to compare');
                return;
            }
            
            const runIds = Array.from(selectedRuns).join(',');
            
            try {
                const response = await fetch(`${API_BASE}/research/compare?run_ids=${runIds}`);
                const data = await response.json();
                
                document.getElementById('comparison-results').style.display = 'block';
                renderComparisonResults(data);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function renderComparisonResults(data) {
            // Summary stats
            const statsHtml = data.map(run => `
                <div class="stat-box">
                    <div class="value">${run.metrics.avg_return.toFixed(1)}%</div>
                    <div class="label">Run #${run.run_id} Avg Return</div>
                </div>
            `).join('');
            document.getElementById('comparison-stats').innerHTML = statsHtml;
            
            // Ablation bar chart
            if (ablationChart) ablationChart.destroy();
            const ctx1 = document.getElementById('ablationChart').getContext('2d');
            ablationChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: data.map(r => `Run #${r.run_id}`),
                    datasets: [{
                        label: 'Average Return (%)',
                        data: data.map(r => r.metrics.avg_return),
                        backgroundColor: data.map((_, i) => 
                            `hsla(${180 + i * 30}, 80%, 50%, 0.7)`
                        ),
                        borderColor: data.map((_, i) => 
                            `hsla(${180 + i * 30}, 80%, 50%, 1)`
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // Distribution chart (box plot approximation using bar + error)
            if (distributionChart) distributionChart.destroy();
            const ctx2 = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.map(r => `Run #${r.run_id}`),
                    datasets: [
                        {
                            label: 'Worst',
                            data: data.map(r => r.metrics.worst_return),
                            backgroundColor: 'rgba(255,77,77,0.7)'
                        },
                        {
                            label: 'Average',
                            data: data.map(r => r.metrics.avg_return),
                            backgroundColor: 'rgba(0,212,255,0.7)'
                        },
                        {
                            label: 'Best',
                            data: data.map(r => r.metrics.best_return),
                            backgroundColor: 'rgba(0,255,136,0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // Comparison table
            const baseline = data[0].metrics.avg_return;
            const tableBody = document.querySelector('#comparison-table tbody');
            tableBody.innerHTML = data.map(run => {
                const config = run.config || {};
                const delta = run.metrics.avg_return - baseline;
                const deltaClass = delta > 0 ? 'positive' : (delta < 0 ? 'negative' : '');
                
                const configStr = [
                    config.enable_memory ? 'üß†' : '',
                    config.enable_reflection ? 'üìù' : '',
                    config.enable_manager ? 'üë®‚Äçüíº' : ''
                ].filter(Boolean).join(' ') || 'Baseline';
                
                return `<tr>
                    <td><strong>#${run.run_id}</strong></td>
                    <td>${configStr}</td>
                    <td>${run.metrics.avg_return.toFixed(2)}%</td>
                    <td>${run.metrics.std_return.toFixed(2)}%</td>
                    <td>${run.metrics.avg_sharpe.toFixed(2)}</td>
                    <td>${run.metrics.avg_win_rate.toFixed(1)}%</td>
                    <td class="${deltaClass}">${delta > 0 ? '+' : ''}${delta.toFixed(2)}%</td>
                </tr>`;
            }).join('');
        }
        
        // PSYCHOLOGY: Load runs dropdown
        async function loadPsychRuns() {
            try {
                const response = await fetch(`${API_BASE}/runs`);
                const runs = await response.json();
                
                const select = document.getElementById('psychRunSelect');
                select.innerHTML = '<option value="">Select a run...</option>' + 
                    runs.map(r => `<option value="${r.run_id}">Run #${r.run_id} - ${r.config?.description || r.start_month + ' to ' + r.end_month}</option>`).join('');
            } catch (error) {
                console.error('Error loading runs:', error);
            }
        }
        
        // PSYCHOLOGY: Load psychology data
        async function loadPsychologyData() {
            const runId = document.getElementById('psychRunSelect').value;
            if (!runId) return;
            
            try {
                const response = await fetch(`${API_BASE}/research/psychology?run_id=${runId}`);
                const data = await response.json();
                
                document.getElementById('psychology-results').style.display = 'block';
                renderPsychologyResults(data);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function renderPsychologyResults(data) {
            const agents = data.agents;
            
            // Summary stats
            const avgDesperation = agents.reduce((sum, a) => sum + a.desperation_index, 0) / agents.length;
            const desperateAgents = agents.filter(a => a.desperation_index > 0).length;
            
            document.getElementById('psych-summary-stats').innerHTML = `
                <div class="stat-box">
                    <div class="value">${avgDesperation.toFixed(2)}</div>
                    <div class="label">Avg Desperation Index</div>
                </div>
                <div class="stat-box">
                    <div class="value">${desperateAgents}/${agents.length}</div>
                    <div class="label">Agents Who "Gamble"</div>
                </div>
                <div class="stat-box">
                    <div class="value">${agents[0]?.name || 'N/A'}</div>
                    <div class="label">Most Desperate</div>
                </div>
                <div class="stat-box">
                    <div class="value">${agents[agents.length-1]?.name || 'N/A'}</div>
                    <div class="label">Most Composed</div>
                </div>
            `;
            
            // Desperation chart
            if (desperationChart) desperationChart.destroy();
            const ctx1 = document.getElementById('desperationChart').getContext('2d');
            desperationChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: agents.map(a => a.name),
                    datasets: [{
                        label: 'Desperation Index',
                        data: agents.map(a => a.desperation_index),
                        backgroundColor: agents.map(a => 
                            a.desperation_index > 0 ? 'rgba(255,77,77,0.7)' : 'rgba(0,255,136,0.7)'
                        ),
                        borderColor: agents.map(a => 
                            a.desperation_index > 0 ? '#ff4d4d' : '#00ff88'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // Risk by rank scatter
            if (riskByRankChart) riskByRankChart.destroy();
            const ctx2 = document.getElementById('riskByRankChart').getContext('2d');
            
            // Flatten all monthly data for scatter plot
            const scatterData = [];
            agents.forEach(agent => {
                agent.monthly_analysis.forEach(m => {
                    scatterData.push({
                        x: m.rank_percentile,
                        y: m.risk_score,
                        agent: agent.name
                    });
                });
            });
            
            riskByRankChart = new Chart(ctx2, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Risk vs Ranking',
                        data: scatterData,
                        backgroundColor: 'rgba(0,212,255,0.5)',
                        borderColor: '#00d4ff',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Rank Percentile (100 = 1st Place)', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Risk Score', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // Agent profiles
            document.getElementById('agent-profiles').innerHTML = agents.map(agent => {
                const desperationPct = Math.min(100, Math.max(0, (agent.desperation_index + 2) / 4 * 100));
                const fillColor = agent.desperation_index > 0 ? '#ff4d4d' : '#00ff88';
                
                return `
                    <div class="agent-psych-card">
                        <div class="name">${agent.name} (${agent.personality})</div>
                        <div style="font-size: 0.9em; color: rgba(255,255,255,0.6);">
                            Desperation: ${agent.desperation_index.toFixed(2)}
                        </div>
                        <div class="desperation-bar">
                            <div class="desperation-fill" style="width: ${desperationPct}%; background: ${fillColor};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: rgba(255,255,255,0.5);">
                            <span>Bottom Tier: ${agent.months_in_bottom_tier} months</span>
                            <span>Top Tier: ${agent.months_in_top_tier} months</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // IMPACT: Load runs
        async function loadImpactRuns() {
            try {
                const response = await fetch(`${API_BASE}/runs`);
                const runs = await response.json();
                
                const options = runs.map(r => `<option value="${r.run_id}">Run #${r.run_id} (${r.config?.description || 'No Desc'})</option>`).join('');
                
                document.getElementById('impactBaselineSelect').innerHTML = '<option value="">Select Baseline...</option>' + options;
                document.getElementById('impactManagerSelect').innerHTML = '<option value="">Select Manager Run...</option>' + options;
            } catch (error) {
                console.error('Error loading runs:', error);
            }
        }

        // IMPACT: Run Analysis
        async function runImpactAnalysis() {
            const baselineId = document.getElementById('impactBaselineSelect').value;
            const managerId = document.getElementById('impactManagerSelect').value;
            
            if (!baselineId || !managerId) {
                alert('Please select both runs');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/research/impact?baseline_run_id=${baselineId}&manager_run_id=${managerId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                document.getElementById('impact-results').style.display = 'block';
                renderImpactResults(data);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function renderImpactResults(data) {
            // Stats
            const comp = data.compliance_stats;
            const complianceRate = (comp.compliant / comp.total_risk_feedback * 100) || 0;
            
            document.getElementById('impact-stats').innerHTML = `
                <div class="stat-box">
                    <div class="value">${complianceRate.toFixed(1)}%</div>
                    <div class="label">Compliance Rate</div>
                </div>
                <div class="stat-box">
                    <div class="value">${comp.total_risk_feedback}</div>
                    <div class="label">"Risk" Warnings Issued</div>
                </div>
                <div class="stat-box">
                    <div class="value">${data.bottom_agents.length}</div>
                    <div class="label">Agents Analyzed</div>
                </div>
            `;
            
            // Rescue Chart
            if (rescueChart) rescueChart.destroy();
            const ctx1 = document.getElementById('rescueChart').getContext('2d');
            
            const datasets = [];
            data.rescue_analysis.forEach((agent, i) => {
                const color = `hsla(${i * 120}, 70%, 50%, 1)`;
                datasets.push({
                    label: `${agent.name} (Baseline)`,
                    data: agent.baseline_curve,
                    borderColor: color,
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0
                });
                datasets.push({
                    label: `${agent.name} (Manager)`,
                    data: agent.manager_curve,
                    borderColor: color,
                    borderWidth: 3,
                    pointRadius: 0
                });
            });
            
            rescueChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Array.from({length: data.rescue_analysis[0].baseline_curve.length}, (_, i) => i),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        title: { display: true, text: 'Dashed = Baseline, Solid = Manager', color: 'white' }
                    },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white' } },
                        x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'white' } }
                    }
                }
            });
            
            // Compliance Chart
            if (complianceChart) complianceChart.destroy();
            const ctx2 = document.getElementById('complianceChart').getContext('2d');
            
            complianceChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Compliant (Reduced Risk)', 'Non-Compliant (Ignored)'],
                    datasets: [{
                        data: [comp.compliant, comp.non_compliant],
                        backgroundColor: ['#00ff88', '#ff4d4d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } }
                    }
                }
            });
        }
        
        // Initialize
        loadExperimentHistory();
    </script>
</body>
</html>